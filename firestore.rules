rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if user is moderator or admin
    function isModerator() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['moderator', 'admin'];
    }

    // ────── DEALS ──────
    // Public read, authenticated create, owner/admin can update/delete, anyone can update netVotes
    match /deals/{dealId} {
      allow read: if true;
      allow create: if request.auth != null &&
                       request.resource.data.keys().hasAll(['title', 'description', 'store', 'createdAt', 'submittedBy']) &&
                       (request.resource.data.submittedBy == request.auth.uid || request.resource.data.submittedBy == 'system' || request.resource.data.submittedBy == 'admin') &&
                       request.resource.data.title is string && request.resource.data.title.size() > 0 &&
                       request.resource.data.description is string && request.resource.data.description.size() > 0 &&
                       request.resource.data.createdAt is timestamp;
      allow update: if request.auth != null && (
                       // Owner or admin can update anything
                       (request.auth.uid == resource.data.submittedBy || isAdmin()) ||
                       // Anyone authenticated can update only netVotes (for voting system)
                       (request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['netVotes']))
                       );
      allow delete: if request.auth != null &&
                       (request.auth.uid == resource.data.submittedBy || isAdmin());
    }

    // ────── USERS ──────
    // Public read, owner can write
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
    }

    // ────── COMMENTS ──────
    // Public read, authenticated create, owner/admin can update/delete
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null &&
                       request.resource.data.dealId is string &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 1000 &&
                       request.resource.data.createdAt is timestamp;
      allow update: if request.auth != null && (
                       // Owner or moderator can edit content
                       (request.auth.uid == resource.data.user.id || isModerator()) ||
                       // Anyone authenticated can update only the upvotes field (voting)
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes'])
                       );
      allow delete: if request.auth != null &&
                       (request.auth.uid == resource.data.user.id || isModerator());
    }

    // ────── VOTES ──────
    // Owner only - user can only vote on their own deals
    match /votes/{userId}/dealUpvotes/{dealId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      allow update: if false; // Votes are write-once, delete and recreate
    }

    match /votes/{userId}/dealDownvotes/{dealId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      allow update: if false; // Votes are write-once, delete and recreate
    }

    match /votes/{userId}/commentUpvotes/{commentId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      allow update: if false;
    }

    match /votes/{userId}/commentDownvotes/{commentId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      allow update: if false;
    }

    // ────── SAVED DEALS ──────
    // Owner only
    match /savedDeals/{userId}/deals/{dealId} {
      allow read, create, delete: if request.auth != null && request.auth.uid == userId;
      allow update: if false; // Saved deals are write-once, delete and recreate
    }

    // ────── STORES ──────
    // Public read, admin only write
    match /stores/{storeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ────── CATEGORIES ──────
    // Public read, admin only write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ────── DEFAULT ──────
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
